import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';
import { setGlobalLogoutFunction } from '../lib/api';

export type Role = 'admin' | 'consultant';

export interface AuthUser {
  role: Role;
  email: string;
  name?: string;
  token?: string;
}

interface AuthContextType {
  user: AuthUser | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  login: (params: { email: string; password: string; role: Role }) => Promise<void>;
  logout: () => void;
}

const defaultAuthContext: AuthContextType = {
  user: null,
  isAuthenticated: false,
  isLoading: true,
  login: async () => { throw new Error('AuthProvider not found'); },
  logout: () => { console.error('AuthProvider not found'); }
};

const AuthContext = createContext<AuthContextType>(defaultAuthContext);

const AUTH_STORAGE_KEY = 'emlak_auth_user';

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<AuthUser | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // Load persisted auth
  useEffect(() => {
    console.log('üîç AuthContext: Loading persisted auth...');
    try {
      const raw = localStorage.getItem(AUTH_STORAGE_KEY);
      console.log('üîç AuthContext: Raw localStorage data:', raw ? 'EXISTS' : 'NOT FOUND');
      if (raw) {
        const parsed = JSON.parse(raw) as AuthUser;
        console.log('üîç AuthContext: Parsed user data:', parsed);
        console.log('üîç AuthContext: Has token:', !!parsed.token);
        setUser(parsed);
        console.log('üîç AuthContext: User set successfully');
      }
    } catch (e) {
      console.error('‚ùå AuthContext: Failed to read auth from storage', e);
      localStorage.removeItem(AUTH_STORAGE_KEY);
    } finally {
      console.log('üîç AuthContext: Setting isLoading to false');
      setIsLoading(false);
    }
  }, []);

  // Persist auth
  useEffect(() => {
    try {
      if (user) localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(user));
      else localStorage.removeItem(AUTH_STORAGE_KEY);
    } catch (e) {
      console.error('Failed to write auth to storage', e);
    }
  }, [user]);

  const login: AuthContextType['login'] = async ({ email, password, role }) => {
    console.log('üîç AuthContext: Demo login attempt started', { email, role });
    
    // Demo mode - basit doƒürulama
    if (!email || !password) {
      throw new Error('E-posta ve ≈üifre gereklidir');
    }
    
    // Demo kullanƒ±cƒ± bilgileri
    const demoUsers = {
      'admin@emlak.com': { name: 'Admin Kullanƒ±cƒ±', role: 'admin' as Role },
      'danƒ±≈üman@emlak.com': { name: 'Danƒ±≈üman Kullanƒ±cƒ±', role: 'consultant' as Role }
    };
    
    const userInfo = demoUsers[email as keyof typeof demoUsers];
    
    if (!userInfo || userInfo.role !== role) {
      throw new Error('Ge√ßersiz kullanƒ±cƒ± bilgileri');
    }
    
    // Demo token olu≈ütur
    const demoToken = `demo-token-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    const authed: AuthUser = {
      email,
      role: userInfo.role,
      name: userInfo.name,
      token: demoToken
    };
    
    console.log('‚úÖ AuthContext: Demo login successful, setting user:', authed);
    setUser(authed);
  };

  const logout = () => {
    setUser(null);
    // Redirect to login page after logout
    window.location.href = '/login';
  };

  // Set global logout function for API error handling
  useEffect(() => {
    setGlobalLogoutFunction(logout);
  }, []);

  const isAuthenticated = !!user && !!user.token;
  
  console.log('üîç AuthContext: Computing auth state:', {
    user: user ? { email: user.email, role: user.role, hasToken: !!user.token } : null,
    isAuthenticated,
    isLoading
  });

  const value = useMemo<AuthContextType>(
    () => ({ user, isAuthenticated, isLoading, login, logout }),
    [user, isAuthenticated, isLoading]
  );

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

export const useAuth = () => {
  const ctx = useContext(AuthContext);
  if (!ctx || ctx === defaultAuthContext) {
    console.warn('useAuth called outside of AuthProvider, returning default context');
    return defaultAuthContext;
  }
  return ctx;
};